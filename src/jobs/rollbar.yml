description: >
  cdk rollbar

executor:
  name: default
  tag: << parameters.node_version >>

parameters:
  attach_at:
    description: where should we attach the workspace
    default: "."
    type: string
  environment:
    default: ENVIRONMENT
    description: The environment to apply on.
    type: env_var_name
  setup_remote_docker:
    default: false
    description: enable docker
    type: boolean
  node_version:
    description: the version of node to use in executor
    type: string
    default: "18.13.0" 

  steps:
    - checkout
    - run: ls -lah /home/circleci/project
    - run:
        name: get rollbar token
        command: echo 'export ROLLBAR_ACCESS_TOKEN=$(yq -r ".defaults.rollbarToken" $CIRCLE_WORKING_DIRECTORY/config/env.yaml)' >> $BASH_ENV
    - run:
        name: echo rollbar token
        command: echo $ROLLBAR_ACCESS_TOKEN
    - deploy/notify_deploy:
        environment: << parameters.environment >>
  
  - notify_deploy:
      attach_at: << parameters.attach_at >>
      environment: << parameters.environment >>
      node_version: << parameters.node_version >>